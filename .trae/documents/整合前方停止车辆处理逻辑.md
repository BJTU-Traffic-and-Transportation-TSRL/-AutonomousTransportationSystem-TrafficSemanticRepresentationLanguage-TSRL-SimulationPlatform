## 整合前方停止车辆处理逻辑计划

### 1. 分析现有代码

#### ego_vehicle_planner.py 中的前方停止车辆处理逻辑
- **障碍物列表添加**：第45-70行，将预测车辆作为动态障碍物添加到obs_list
- **轨迹生成器选择**：
  - 保持车道行为(KL)时，根据条件选择stop_trajectory_generator或lanekeeping_trajectory_generator
  - 当即将进入交叉口且交通灯为红色时，调用stop_trajectory_generator
  - 当速度<10km/h时，调用stop_trajectory_generator
- **停止位置计算**：在stop_trajectory_generator函数中，根据障碍物位置计算停止位置
- **轨迹生成**：根据选择的轨迹生成器生成轨迹
- **互操作消息发送**：在stop_trajectory_generator中，紧急停车时发送EmergencyStation消息
- **停车状态管理**：在stop_trajectory_generator中管理车辆停止状态

#### TSRL_ego_vehicle_planner.py 中的现有结构
- 已具备基本框架，包括障碍物处理、行为决策和轨迹生成
- 有行为变化检测、特殊处理行为等额外功能
- 前方停止车辆检测逻辑被注释掉（第139-161行）

### 2. 整合计划

#### 步骤1：恢复并完善前方停止车辆检测逻辑
- 取消注释第139-161行的代码
- 完善前方停止车辆检测逻辑，确保能正确识别同一车道或相邻车道的停止车辆
- 添加距离检测，只处理一定距离内的停止车辆

#### 步骤2：改进轨迹生成器选择逻辑
- 在KL行为下，当检测到前方有停止车辆时，调用stop_trajectory_generator
- 确保force_stop参数正确传递，触发适当的停车逻辑
- 保持与原有代码的兼容性

#### 步骤3：优化互操作消息发送
- 确保在检测到前方停止车辆时，能正确发送相应的互操作消息
- 添加消息发送的条件判断，避免重复发送
- 确保消息格式正确

#### 步骤4：完善停车状态管理
- 确保车辆的stop_flag状态正确设置和清除
- 添加对stop_until时间的管理
- 确保车辆在适当的时候恢复正常行驶

#### 步骤5：测试与验证
- 确保整合后的代码逻辑连贯，无语法错误
- 确保在各种场景下都能正确处理前方停止车辆
- 确保互操作消息能正确发送
- 确保停车状态能正确管理

### 3. 预期结果

整合后的TSRL_ego_vehicle_planner.py的plan方法将能够：
- 正确检测前方停止车辆
- 根据检测结果选择合适的轨迹生成器
- 生成安全、高效的停车轨迹
- 正确发送互操作消息
- 有效管理车辆的停车状态

### 4. 整合要点

- 保持代码的可读性和可维护性
- 确保与现有代码的兼容性
- 避免重复代码
- 确保逻辑清晰，易于理解
- 遵循现有的代码风格和命名规范